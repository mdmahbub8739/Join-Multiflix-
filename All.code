Here is the total upgrade based on your requirements.

### Key Changes Made:
1.  **Actor Profile System:**
    *   Added a dedicated **Actor Page** (`#actor-page`).
    *   Clicking an actor in "Popular Stars" or Search now opens this profile instead of filling the search bar.
    *   **Infinite Scroll:** Loads 5 performances at a time automatically when you scroll to the bottom.
    *   **Request Logic:** When all performances are loaded, a "Request more content for [Actor Name]" card appears at the end.
2.  **Genre Cards (Clean Look):**
    *   Removed blur effects.
    *   Stopped random API fetching for backgrounds. Now uses specific, high-quality static image paths for a clean, consistent look.
3.  **Home Page "New Experience":**
    *   Redesigned the Hero Section for a cleaner, more cinematic look (Gradient overlays adjusted, text positioning refined).
    *   Adjusted the "Trending" section layout.
4.  **Episode Images:**
    *   Added logic to prevent the "Same Image" spam. If a specific episode still (`ep.still`) is missing, it now generates a cool **CSS-based placeholder** with the Episode Number instead of reusing the series poster repeatedly.
5.  **Request Notifications:**
    *   Implemented client-side rate limiting (Max 3 requests per minute).
    *   Added "Soft but engaging" messages for limits.
    *   Distinguished between "Request Granted" and "Existing Request".

---

### 1. index.html

```html
--- START OF FILE index.html ---


<?php
// --- SERVER SIDE LOGIC (Facebook/Messenger Link Preview) ---
$tmdb_api_key = "9860008cae8536cb209f1e20420aa279"; // তোর API Key
$app_name = "MultiFlix";

// ডিফল্ট ভ্যালু (তোর HTML থেকে নেওয়া)
$default_image = "https://ui-avatars.com/api/?name=Multi+Flix&background=E50914&color=fff&size=512";
$default_title = "MultiFlix - Watch Free Movies & Series";
$default_desc = "Stream the latest movies and TV series in HD.";

$og_title = $default_title;
$og_image = $default_image;
$og_desc = $default_desc;

// যদি লিংকে আইডি থাকে
if (isset($_GET['id']) && isset($_GET['type'])) {
    $id = $_GET['id'];
    $type = ($_GET['type'] == 'series' || $_GET['type'] == 'tv') ? 'tv' : 'movie';
    
    $url = "https://api.themoviedb.org/3/$type/$id?api_key=$tmdb_api_key";
    $json = @file_get_contents($url);
    
    if ($json) {
        $data = json_decode($json, true);
        
        // টাইটেল
        $title_text = ($type == 'tv') ? ($data['name'] ?? '') : ($data['title'] ?? '');
        if ($title_text) {
            $og_title = "$title_text - Watch on $app_name";
        }
        
        // ছবি
        if (!empty($data['backdrop_path'])) {
            $og_image = "https://image.tmdb.org/t/p/w1280" . $data['backdrop_path'];
        } elseif (!empty($data['poster_path'])) {
            $og_image = "https://image.tmdb.org/t/p/w780" . $data['poster_path'];
        }
        
        // বর্ণনা
        if (!empty($data['overview'])) {
            $og_desc = htmlspecialchars(substr($data['overview'], 0, 160)) . "...";
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    
    <!-- Dynamic Title & SEO -->
    <title><?php echo $og_title; ?></title>
    <meta name="title" content="<?php echo $og_title; ?>">
    <meta name="description" content="<?php echo $og_desc; ?>">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="<?php echo $og_title; ?>">
    <meta property="og:description" content="<?php echo $og_desc; ?>">
    <meta property="og:image" content="<?php echo $og_image; ?>">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<?php echo $og_title; ?>">
    <meta name="twitter:description" content="<?php echo $og_desc; ?>">
    <meta name="twitter:image" content="<?php echo $og_image; ?>">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Tailwind Configuration -->
    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: 'var(--brand-color)',
                        base: '#000000',
                        surface: '#121212',
                        highlight: '#2A2A2A'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop-in': 'popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': {
                                opacity: '0'
                            },
                            '100%': {
                                opacity: '1'
                            }
                        },
                        slideUp: {
                            '0%': {
                                transform: 'translateY(20px)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'translateY(0)',
                                opacity: '1'
                            }
                        },
                        popIn: {
                            '0%': {
                                transform: 'scale(0.95)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'scale(1)',
                                opacity: '1'
                            }
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="font-sans antialiased selection:bg-brand selection:text-white bg-black text-gray-200">

    <!-- SPLASH -->
    <div id="app-splash">
        <div class="splash-loader"></div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification-container" class="fixed top-20 right-5 z-[110] flex flex-col gap-3 pointer-events-none"></div>

    <!-- MODALS -->
    <div id="legal-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/95 p-5 backdrop-blur-sm animate-fade-in">
        <div class="bg-surface border border-white/10 w-full max-w-2xl h-[80vh] rounded-2xl flex flex-col shadow-2xl animate-pop-in">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-highlight/50">
                <h3 id="legal-modal-title" class="font-bold text-white text-lg">Legal</h3>
                <button onclick="closeLegalModal()" class="text-gray-400 hover:text-white bg-white/5 rounded-full p-1"><i class="ri-close-line text-xl"></i></button>
            </div>
            <div id="legal-modal-body" class="p-6 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <div id="server-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-5 animate-fade-in">
        <div class="bg-surface border border-white/10 w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl animate-pop-in">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-highlight/50">
                <h3 class="font-bold text-white flex items-center gap-2"><i class="ri-server-line text-brand"></i> Select Server</h3>
                <button onclick="closeServerModal()" class="text-gray-400 hover:text-white bg-white/5 rounded-full p-1"><i class="ri-close-line text-xl"></i></button>
            </div>
            <div id="server-list-container" class="p-4 max-h-[60vh] overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/80 p-5 backdrop-blur-sm">
        <div class="bg-surface border border-white/10 p-6 rounded-2xl max-w-sm w-full shadow-2xl animate-slide-up">
            <div class="text-brand text-4xl mb-2"><i class="ri-customer-service-2-line"></i></div>
            <h3 class="text-xl font-bold text-white mb-2">Request Content</h3>
            <p class="text-gray-400 text-sm mb-6 leading-relaxed" id="confirm-modal-text"></p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-400 bg-highlight hover:bg-white/10 transition">Cancel</button>
                <button id="confirm-action-btn" class="flex-1 py-3 rounded-xl font-bold text-white bg-brand hover:brightness-110 transition shadow-lg shadow-brand/20">Request Now</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="w-full md:max-w-7xl mx-auto min-h-screen bg-base pb-20 relative shadow-2xl shadow-white/5 border-x border-white/5">

        <!-- HEADER -->
        <header class="fixed top-0 left-0 right-0 w-full md:max-w-7xl mx-auto z-50 p-5 flex justify-between items-center bg-gradient-to-b from-black/90 via-black/40 to-transparent transition-all duration-500">
            <div id="app-logo-container" onclick="showPage('home-page')" class="cursor-pointer">
                <h1 class="text-2xl font-black tracking-tighter text-brand drop-shadow-xl">MULTI<span class="text-white">FLIX</span></h1>
            </div>

            <div class="flex items-center gap-3">
                <button id="install-app-btn" class="hidden w-9 h-9 rounded-full bg-white text-black flex items-center justify-center hover:bg-gray-200 transition">
                    <i class="ri-download-2-fill text-lg"></i>
                </button>
                <button onclick="toggleSearchOverlay()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-brand transition backdrop-blur-sm">
                    <i class="ri-search-2-line text-xl"></i>
                </button>
                <button id="header-profile-btn" class="text-gray-300 hover:text-white transition active:scale-95" onclick="openAuthModal()">
                    <div class="w-9 h-9 rounded-full bg-white/10 border border-white/10 flex items-center justify-center text-white overflow-hidden backdrop-blur-sm">
                        <img id="user-avatar" src="" class="w-full h-full object-cover hidden">
                        <i id="user-icon" class="ri-user-fill"></i>
                    </div>
                </button>
            </div>
        </header>

        <!-- SEARCH OVERLAY -->
        <div id="global-search-overlay" class="fixed inset-0 bg-base flex flex-col pt- safe-top">
            <div class="p-4 glass-header flex items-center gap-3">
                <button onclick="toggleSearchOverlay()" class="w-10 h-10 rounded-full bg-highlight flex items-center justify-center text-white hover:bg-brand transition">
                    <i class="ri-arrow-down-s-line text-xl"></i>
                </button>
                <div class="flex-1 relative">
                    <input type="text" id="global-search-input" class="w-full bg-highlight text-white rounded-full py-3 px-5 pl-12 focus:outline-none focus:ring-2 focus:ring-brand font-medium" placeholder="Search movies, series, people...">
                    <i class="ri-search-line absolute left-4 top-3.5 text-gray-400"></i>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-5 pb-24 custom-scrollbar">
                <div id="search-section-local" class="mb-8 hidden">
                    <h3 class="text-brand font-bold text-xs uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ri-play-circle-fill"></i> Watch Now</h3>
                    <div id="search-results-local" class="grid grid-cols-3 md:grid-cols-5 gap-3"></div>
                </div>
                <div id="search-section-tmdb" class="mb-8 hidden">
                    <h3 class="text-blue-500 font-bold text-xs uppercase tracking-wider mb-3 flex items-center gap-2"><i class="ri-download-cloud-2-fill"></i> Request to Add</h3>
                    <div id="search-results-tmdb" class="grid grid-cols-3 md:grid-cols-5 gap-3"></div>
                </div>
                <div id="search-loader" class="hidden py-10 flex justify-center">
                    <div class="content-loader"></div>
                </div>
            </div>
        </div>

        <main>
            <!-- HOME PAGE -->
            <div id="home-page" class="page active !pt-0">
                <div id="banner-carousel" class="relative w-full bg-surface">
                    <div class="w-full h-[65vh] md:h-[80vh] skeleton"></div>
                </div>
                <div id="home-content" class="relative z-20 -mt-8 space-y-8 min-h-[400px]"></div>
                <footer class="relative z-20 pb-24 pt-12 px-5 text-center border-t border-white/5 mt-8">
                    <h2 class="text-brand font-black text-2xl mb-4">MULTI<span class="text-white">FLIX</span></h2>
                    <div class="flex justify-center gap-6 mb-6 text-sm text-gray-400 font-medium">
                        <button onclick="openLegalModal('dmca')" class="hover:text-white transition">DMCA</button>
                        <button onclick="openLegalModal('privacy')" class="hover:text-white transition">Privacy Policy</button>
                    </div>
                    <p class="text-[10px] text-gray-600 max-w-md mx-auto leading-relaxed">
                        MultiFlix does not host content; we only index links just like Google. Content is immediately removed upon proof of ownership. 
                        <br><span class="text-gray-500">Contact: multiflix@outlook.com</span>
                    </p>
                </footer>
            </div>

            <!-- ACTOR PAGE -->
            <div id="actor-page" class="page px-0 !pt-0 bg-base z-[55] fixed inset-0 overflow-y-auto hidden">
                <div class="relative w-full">
                    <div class="fixed top-0 left-0 w-full z-50 p-4 flex justify-between items-center pointer-events-none">
                        <button onclick="closeActorPage()" class="pointer-events-auto bg-black/40 backdrop-blur-md p-2 rounded-full text-white hover:bg-brand transition shadow-lg"><i class="ri-arrow-left-line text-2xl"></i></button>
                    </div>
                    
                    <div id="actor-header" class="relative w-full h-[50vh] md:h-[60vh] overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-t from-base via-transparent to-transparent z-10"></div>
                        <img id="actor-cover-image" class="w-full h-full object-cover object-top opacity-80">
                        <div class="absolute bottom-0 left-0 w-full p-5 z-20">
                            <h1 id="actor-name" class="text-4xl md:text-6xl font-black text-white drop-shadow-lg mb-2"></h1>
                            <div class="flex gap-4 text-sm text-gray-300 font-medium">
                                <span id="actor-dob"></span>
                                <span id="actor-place"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-5 relative z-20 bg-base min-h-screen -mt-4 rounded-t-3xl">
                        <div class="mb-8">
                            <h3 class="text-brand font-bold uppercase tracking-wider text-xs mb-2">Biography</h3>
                            <p id="actor-bio" class="text-gray-400 text-sm leading-relaxed line-clamp-4 cursor-pointer hover:line-clamp-none transition-all"></p>
                        </div>
                        
                        <h3 class="text-white font-bold text-xl mb-4">Known For</h3>
                        <div id="actor-credits-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            <!-- Populated via JS -->
                        </div>
                        
                        <!-- Infinite Scroll Trigger -->
                        <div id="actor-scroll-trigger" class="py-10 flex justify-center w-full">
                            <div class="content-loader"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DISCOVER PAGE -->
            <div id="categories-page" class="page px-5">
                <div class="mb-6 mt-4">
                    <h2 class="text-3xl font-black text-white mb-2">Discover</h2>
                    <p class="text-gray-400 text-sm">Browse by genre with top trending content</p>
                </div>
                <div id="genre-grid-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                    <div class="col-span-full flex justify-center py-10">
                        <div class="content-loader"></div>
                    </div>
                </div>
                <div id="category-search-container" class="hidden mb-6 sticky top-[70px] z-30 animate-fade-in">
                    <div class="relative shadow-xl">
                        <input type="text" id="category-search-input" class="w-full bg-highlight/90 backdrop-blur-md text-white rounded-xl py-3 px-5 pl-12 focus:outline-none focus:ring-2 focus:ring-brand border border-white/10" placeholder="Search in this category...">
                        <i class="ri-search-2-line absolute left-4 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                <div id="category-results-container">
                    <div id="genre-header" class="hidden flex justify-between items-end mb-4 border-b border-white/10 pb-2">
                        <h3 id="selected-genre-title" class="text-xl font-bold text-brand">Action</h3>
                    </div>
                    <div id="category-loader" class="hidden py-10 flex justify-center w-full"><div class="content-loader"></div></div>
                    <div id="category-tmdb-results" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3 md:gap-6"></div>
                    <div id="category-load-more" class="hidden"><button onclick="loadNextPage()" class="load-more-btn">Load Next 20 <i class="ri-arrow-down-line"></i></button></div>
                </div>
            </div>

            <!-- MOVIES PAGE -->
            <div id="movies-page" class="page !pt-0">
                <div id="movies-banner" class="relative w-full h-[50vh] bg-surface flex items-center justify-center overflow-hidden">
                    <div class="skeleton absolute inset-0 w-full h-full z-10"></div>
                    <img id="movies-hero-img" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-base via-base/40 to-transparent z-0"></div>
                    <h2 class="absolute bottom-5 left-5 text-3xl font-black text-white drop-shadow-xl z-20">Movies</h2>
                </div>
                <div id="movies-content" class="relative z-20 -mt-4 px-5 grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3 md:gap-6"></div>
                <div id="movies-loader" class="content-loader-container hidden">
                    <div class="content-loader"></div>
                </div>
                <div id="movies-more-btn" class="hidden"><button onclick="loadNextPage()" class="load-more-btn">Load Next 20 <i class="ri-arrow-down-line"></i></button></div>
            </div>

            <!-- SERIES PAGE -->
            <div id="series-page" class="page !pt-0">
                <div id="series-banner" class="relative w-full h-[50vh] bg-surface flex items-center justify-center overflow-hidden">
                    <div class="skeleton absolute inset-0 w-full h-full z-10"></div>
                    <img id="series-hero-img" class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-700">
                    <div class="absolute inset-0 bg-gradient-to-t from-base via-base/40 to-transparent z-0"></div>
                    <h2 class="absolute bottom-5 left-5 text-3xl font-black text-white drop-shadow-xl z-20">Series</h2>
                </div>
                <div id="series-content" class="relative z-20 -mt-4 px-5 grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3 md:gap-6"></div>
                <div id="series-loader" class="content-loader-container hidden">
                    <div class="content-loader"></div>
                </div>
                <div id="series-more-btn" class="hidden"><button onclick="loadNextPage()" class="load-more-btn">Load Next 20 <i class="ri-arrow-down-line"></i></button></div>
            </div>

            <!-- MY LIST PAGE -->
            <div id="mylist-page" class="page px-5">
                <div class="flex justify-between items-end mb-8 mt-4">
                    <h2 class="text-3xl font-bold">My List</h2>
                    <span class="text-sm font-medium text-brand" id="mylist-count">0</span>
                </div>
                <div id="mylist-grid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3 md:gap-6 pb-24"></div>
            </div>

            <!-- PLAYER PAGE -->
            <div id="player-page" class="page bg-base min-h-screen z-[60] pb-0 fixed inset-0 overflow-y-auto !pt-0">
                <div class="fixed top-0 left-0 w-full z-50 p-4 pointer-events-none">
                    <button onclick="closePlayerPage()" class="pointer-events-auto bg-black/40 backdrop-blur-md p-2 rounded-full text-white hover:bg-brand transition shadow-lg"><i class="ri-arrow-left-line text-2xl"></i></button>
                </div>
                <div class="w-full bg-black sticky top-0 z-40 shadow-2xl shadow-black">
                    <div id="video-area" class="w-full max-w-7xl mx-auto aspect-video bg-black relative"></div>
                    
                    <!-- NEW CONTROLS CONTAINER -->
                    <div id="player-controls-container" class="hidden w-full max-w-7xl mx-auto bg-highlight border-b border-white/5 p-3 flex justify-between items-center">
                        <!-- Controls will be injected by script.js -->
                    </div>

                    <div id="server-trigger-bar" onclick="openServerModal()" class="cursor-pointer bg-surface border-y border-white/10 py-3 px-5 flex justify-between items-center hover:bg-highlight transition group hidden">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-highlight flex items-center justify-center text-brand group-hover:scale-110 transition"><i class="ri-server-fill"></i></div>
                            <div>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Select Server Resources</p>
                                <p id="current-server-name" class="text-sm font-bold text-white leading-tight">Loading...</p>
                            </div>
                        </div>
                        <i class="ri-arrow-right-s-line text-gray-500 group-hover:text-white text-xl"></i>
                    </div>
                </div>
                <div class="p-5 pb-24 relative z-30 bg-base min-h-[50vh] max-w-7xl mx-auto">
                    <div id="player-meta"></div>
                    <div class="flex border-b border-white/10 mt-6 mb-6 sticky top-0 bg-base z-20 pt-2 overflow-x-auto no-scrollbar">
                        <button onclick="switchTab('episodes')" id="tab-episodes" class="tab-btn px-4 pb-3 text-sm font-semibold text-gray-400 hover:text-white whitespace-nowrap hidden">Episodes</button>
                        <button onclick="switchTab('similar')" id="tab-similar" class="tab-btn active px-4 pb-3 text-sm font-semibold text-gray-400 hover:text-white whitespace-nowrap">Similar</button>
                        <!-- ADDED DISCOVERY BUTTON -->
                        <button onclick="switchTab('discovery')" id="tab-discovery" class="tab-btn px-4 pb-3 text-sm font-semibold text-gray-400 hover:text-white whitespace-nowrap">Discovery</button>
                        <button onclick="switchTab('downloads')" id="tab-downloads" class="tab-btn px-4 pb-3 text-sm font-semibold text-gray-400 hover:text-white whitespace-nowrap">Downloads</button>
                        <button onclick="switchTab('comments')" id="tab-comments" class="tab-btn px-4 pb-3 text-sm font-semibold text-gray-400 hover:text-white whitespace-nowrap">Comments</button>
                    </div>
                    <div id="content-episodes" class="tab-content hidden animate-fade-in">
                        <div id="season-selector-container" class="mb-4 md:max-w-md"><select id="season-select" onchange="renderEpisodes(this.value)" class="w-full bg-highlight text-white p-3 rounded-lg outline-none font-bold border border-white/10 focus:border-brand"></select></div>
                        <div id="episodes-list" class="space-y-3 md:grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                    </div>
                    <div id="content-similar" class="tab-content block animate-fade-in">
                        <div id="similar-grid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3 md:gap-6"></div>
                        <div id="similar-loader" class="content-loader-container hidden">
                            <div class="content-loader"></div>
                        </div>
                        <div id="similar-load-more-btn" class="hidden"><button onclick="loadNextSimilarPage()" class="load-more-btn">Load Next 20 <i class="ri-arrow-down-line"></i></button></div>
                    </div>
                    <!-- ADDED DISCOVERY CONTENT WITH LOAD MORE -->
                    <div id="content-discovery" class="tab-content hidden animate-fade-in">
                        <div id="discovery-grid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3 md:gap-6"></div>
                        <div id="discovery-load-more-btn" class="hidden">
                            <button onclick="loadNextDiscoveryPage()" class="load-more-btn">Load Next 20 <i class="ri-arrow-down-line"></i></button>
                        </div>
                    </div>
                    <div id="content-downloads" class="tab-content hidden animate-fade-in">
                        <div id="downloads-list" class="space-y-3 md:grid md:grid-cols-2 md:gap-4 md:space-y-0"></div>
                    </div>
                    <div id="content-comments" class="tab-content hidden animate-fade-in">
                        <div class="flex gap-2 mb-6"><input id="comment-input" type="text" class="flex-1 bg-highlight rounded-lg px-4 py-3 text-sm text-white outline-none" placeholder="Add a comment..."><button onclick="postComment()" class="bg-brand text-white px-4 py-2 rounded-lg"><i class="ri-send-plane-fill"></i></button></div>
                        <div id="comments-list" class="space-y-5"></div>
                    </div>
                </div>
            </div>

            <!-- AUTH MODAL -->
            <div id="auth-modal" class="fixed inset-0 z-[100] hidden flex items-end md:items-center justify-center">
                <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeAuthModal()"></div>
                <div class="relative bg-surface w-full md:w-[400px] md:rounded-2xl rounded-t-3xl p-8 border-t md:border border-white/10 shadow-2xl animate-slide-up">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-2xl font-black text-brand">ACCOUNT</h1>
                        <button onclick="closeAuthModal()" class="text-gray-400 hover:text-white"><i class="ri-close-line text-2xl"></i></button>
                    </div>
                    <div id="auth-view-guest">
                        <div id="login-container">
                            <form id="login-form" class="space-y-4">
                                <input type="email" id="login-email" class="w-full bg-highlight rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-brand" placeholder="Email" required>
                                <input type="password" id="login-password" class="w-full bg-highlight rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-brand" placeholder="Password" required>
                                <button type="submit" class="w-full bg-brand hover:brightness-110 rounded-xl p-4 font-bold text-white shadow-lg">Sign In</button>
                            </form>
                            <p class="text-center text-gray-400 mt-6 text-sm">New? <button id="show-signup-btn" class="text-white font-bold hover:underline">Create account</button></p>
                        </div>
                        <div id="signup-container" class="hidden">
                            <form id="signup-form" class="space-y-4">
                                <input type="email" id="signup-email" class="w-full bg-highlight rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-brand" placeholder="Email" required>
                                <input type="password" id="signup-password" class="w-full bg-highlight rounded-xl p-4 text-white outline-none focus:ring-2 focus:ring-brand" placeholder="Password" required>
                                <button type="submit" class="w-full bg-white text-black hover:bg-gray-200 rounded-xl p-4 font-bold shadow-lg">Sign Up</button>
                            </form>
                            <p class="text-center text-gray-400 mt-6 text-sm">Member? <button id="show-login-btn" class="text-brand font-bold hover:underline">Log in</button></p>
                        </div>
                        <p id="auth-error" class="text-red-500 text-center text-xs mt-4"></p>
                    </div>
                    <div id="auth-view-user" class="hidden text-center">
                        <div class="w-16 h-16 bg-highlight rounded-full mx-auto flex items-center justify-center mb-4 text-2xl text-white"><i class="ri-user-smile-line"></i></div>
                        <p class="text-white font-bold mb-1">Logged In</p>
                        <p class="text-gray-400 text-xs mb-6 font-mono" id="user-email-display"></p>
                        <button onclick="handleSignOut()" class="w-full bg-white/10 hover:bg-white/20 text-red-500 py-4 rounded-xl font-bold border border-white/5 flex items-center justify-center gap-2"><i class="ri-logout-box-r-line"></i> Sign Out</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- BOTTOM NAV -->
        <nav class="fixed bottom-0 left-0 right-0 w-full md:max-w-7xl mx-auto glass-nav z-40 pb-safe rounded-t-2xl">
            <div class="flex justify-around items-center h-16 px-2">
                <button data-page="home-page" class="nav-btn text-white flex flex-col items-center w-1/5 group">
                    <i class="ri-home-5-fill text-2xl mb-1"></i><span class="text-[10px] font-bold">Home</span>
                </button>
                <button data-page="categories-page" class="nav-btn text-gray-500 flex flex-col items-center w-1/5 group">
                    <i class="ri-compass-3-fill text-2xl mb-1"></i><span class="text-[10px] font-medium">Discover</span>
                </button>
                <button data-page="movies-page" class="nav-btn text-gray-500 flex flex-col items-center w-1/5 group">
                    <i class="ri-movie-2-line text-2xl mb-1"></i><span class="text-[10px] font-medium">Movies</span>
                </button>
                <button data-page="series-page" class="nav-btn text-gray-500 flex flex-col items-center w-1/5 group">
                    <i class="ri-tv-line text-2xl mb-1"></i><span class="text-[10px] font-medium">Series</span>
                </button>
                <button onclick="handleListClick()" data-page="mylist-page" class="nav-btn text-gray-500 flex flex-col items-center w-1/5 group">
                    <i class="ri-bookmark-line text-2xl mb-1"></i><span class="text-[10px] font-medium">List</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script src="script.js"></script>
</body>

</html>
--- START OF FILE script.js ---

const SUPABASE_URL = "https://zgktvncvqpwxhbigdfks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpna3R2bmN2cXB3eGhiaWdkZmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMjczNDcsImV4cCI6MjA3OTkwMzM0N30.-FntryjMRyBBCeWHL7eB_sZbq1rKF4-RsPEdbSriQP8";

if (typeof supabase === 'undefined') {
    console.error('Supabase CDN not loaded.');
}

const {
    createClient
} = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
const TMDB_API_KEY = "21c94d1181ff795c2eef4fb690d24ab6";

// Global Cache
let contentCache = new Map();
let userFavorites = [],
    popularPeople = [],
    currentUser = null,
    currentOpenId = null,
    currentSeriesData = null;

// --- HERO SLIDER STATE ---
let currentHeroIndex = 0;
let heroItems = [];
let heroTimer;

// Pagination State
let pageState = {
    activePage: 'home-page',
    movies: {
        offset: 0,
        limit: 15
    },
    series: {
        offset: 0,
        limit: 15
    },
    tmdb: {
        page: 1,
        genreId: null,
        type: 'movie'
    },
    similar: {
        offset: 0,
        limit: 15,
        genre: null,
        type: null,
        excludeId: null
    },
    discovery: {
        offset: 0,
        limit: 15
    },
    actor: {
        id: null,
        credits: [],
        offset: 0,
        limit: 5,
        isLoading: false
    },
    isLoading: false
};

let activeServerList = [],
    activeServerIndex = 0;

// Request Limiting State
let requestTimestamps = [];

function createSlug(text) {
    if (!text) return 'unknown';
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-')
        .replace(/^-+/, '')
        .replace(/-+$/, '');
}

function updateHistoryState(url) {
    if (window.location.pathname !== url) {
        history.pushState(null, null, url);
    }
}

async function router() {
    const path = window.location.pathname;

    const movieMatch = path.match(/^\/movie\/(\d+)/);
    if (movieMatch) {
        const id = movieMatch[1];
        await openPlayerPage(id, 'movie', false);
        return;
    }

    const seriesMatch = path.match(/^\/series\/(\d+)(?:\/[^\/]+)?(?:\/season\/(\d+)\/episode\/(\d+))?/);
    if (seriesMatch) {
        const id = seriesMatch[1];
        const seasonNum = seriesMatch[2] ? parseInt(seriesMatch[2]) : null;
        const episodeNum = seriesMatch[3] ? parseInt(seriesMatch[3]) : null;

        await openPlayerPage(id, 'series', false);

        if (seasonNum && episodeNum && currentSeriesData) {
            const seasonIdx = seasonNum - 1;
            const episodeIdx = episodeNum - 1;

            setTimeout(() => {
                const select = document.getElementById('season-select');
                if (select) {
                    if (select.querySelector(`option[value="${seasonIdx}"]`)) {
                        select.value = seasonIdx;
                        renderEpisodes(seasonIdx);
                    } else if (select.querySelector('option[value="flat"]')) {
                        select.value = 'flat';
                        renderEpisodes('flat');
                    }

                    let targetSeason = (currentSeriesData.seasons && currentSeriesData.seasons[seasonIdx]) ? currentSeriesData.seasons[seasonIdx] : null;
                    let eps = targetSeason ? targetSeason.episodes : currentSeriesData.episodes;

                    if (eps && eps[episodeIdx]) {
                        const ep = eps[episodeIdx];
                        let epServers = ep.servers || [];
                        if (epServers.length === 0 && ep.link) epServers = [{
                            name: "Server 1",
                            url: ep.link
                        }];

                        const epData = {
                            title: ep.title || `Episode ${episodeNum}`,
                            servers: epServers,
                            downloadLink: ep.downloadLink
                        };
                        playEpisode(encodeURIComponent(JSON.stringify(epData)), episodeIdx, false);
                    }
                }
            }, 500);
        }
        return;
    }

    if (path !== '/' && path !== '/index.html') {
        history.replaceState(null, null, '/');
    }
    showPage('home-page');
}

window.addEventListener('popstate', () => {
    router();
});

// PWA
let deferredPrompt;
const installBtn = document.getElementById('install-app-btn');
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.classList.remove('hidden');
});
installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const {
            outcome
        } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.classList.add('hidden');
    }
});

function initApp() {
    setupRealtimeListeners();

    sb.from('settings').select('*').limit(1).then(({
        data
    }) => {
        if (data && data.length > 0) {
            const val = data[0];
            if (val.color) document.documentElement.style.setProperty('--brand-color', val.color);
            if (val.app_name) document.title = val.app_name;
            if (val.logo_type === 'image' && val.logo_url) document.getElementById('app-logo-container').innerHTML = `<img src="${val.logo_url}" class="h-8 object-contain">`;
        }
    });

    fetch(`https://api.themoviedb.org/3/person/popular?api_key=${TMDB_API_KEY}&language=en-US&page=1`).then(r => r.json()).then(data => {
        popularPeople = data.results || [];
    });

    Promise.all([
        sb.from('movies').select('*').order('created_at', { ascending: false }).limit(5),
        sb.from('series').select('*').order('created_at', { ascending: false }).limit(5),
        sb.from('movies').select('*').order('created_at', { ascending: false }).limit(10),
        sb.from('series').select('*').order('created_at', { ascending: false }).limit(10)
    ]).then(([bannerMovies, bannerSeries, moviesData, seriesData]) => {
        
        const allItems = [...(bannerMovies.data || []), ...(bannerSeries.data || []), ...(moviesData.data || []), ...(seriesData.data || [])];
        allItems.forEach(i => contentCache.set(String(i.id), {
            ...i,
            type: i.seasons ? 'series' : 'movie'
        }));

        let mixedBanner = [
            ...(bannerMovies.data || []).map(i => ({...i, type: 'movie'})),
            ...(bannerSeries.data || []).map(i => ({...i, type: 'series'}))
        ];
        mixedBanner = mixedBanner.sort(() => 0.5 - Math.random());

        renderHome(mixedBanner, moviesData.data || [], seriesData.data || []);
        
        document.getElementById('app-splash').style.opacity = '0';
        setTimeout(() => document.getElementById('app-splash').remove(), 500);

        router();
    });

    setupAuthListener();
    setupDragScroll();
    setupActorScrollObserver();
}

function setupRealtimeListeners() {
    sb.channel('public:db-changes')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'movies' }, handleNewContent)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'series' }, handleNewContent)
    .subscribe();
}

function handleNewContent(payload) {
    showNotification(`New content added: ${payload.new.title}`, 'success');
    if(pageState.activePage === 'home-page') {
        initApp();
    } else if (pageState.activePage === 'movies-page' && payload.table === 'movies') {
        pageState.movies.offset = 0;
        fetchPaginatedContent('movie');
    } else if (pageState.activePage === 'series-page' && payload.table === 'series') {
        pageState.series.offset = 0;
        fetchPaginatedContent('series');
    }
}

function setupDragScroll() {
    document.addEventListener('mousedown', (e) => {
        const slider = e.target.closest('.drag-scroll');
        if (!slider) return;
        let isDown = true;
        slider.classList.add('active');
        let startX = e.pageX - slider.offsetLeft;
        let scrollLeft = slider.scrollLeft;
        const mouseUp = () => {
            isDown = false;
            slider.classList.remove('active');
            document.removeEventListener('mouseup', mouseUp);
            document.removeEventListener('mousemove', mouseMove);
        };
        const mouseMove = (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2;
            slider.scrollLeft = scrollLeft - walk;
        };
        document.addEventListener('mouseup', mouseUp);
        document.addEventListener('mousemove', mouseMove);
    });
}

// --- UPDATED RENDER HOME (NEW EXPERIENCE) ---
function renderHome(bannerItems, recentMovies, recentSeries) {
    const c = document.getElementById('home-content');
    c.innerHTML = '';

    // 1. HERO SLIDER (Updated Layout)
    if (bannerItems.length > 0) {
        heroItems = bannerItems;
        const heroHtml = `
            <div class="relative w-full h-[70vh] md:h-[85vh] overflow-hidden group">
                <div id="hero-backgrounds" class="absolute inset-0 w-full h-full">
                    ${heroItems.map((m, i) => `
                        <div class="hero-slide absolute inset-0 transition-opacity duration-1000 ease-in-out ${i===0 ? 'opacity-100 z-10' : 'opacity-0 z-0'}">
                            <div class="absolute inset-0 bg-cover bg-center transition-transform duration-[10000ms] ease-linear hover:scale-105" style="background-image: url('${m.thumbnail || m.poster}'); transform: scale(1);"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
                            <div class="absolute inset-0 bg-gradient-to-r from-black via-black/50 to-transparent"></div>
                        </div>
                    `).join('')}
                </div>
                <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 z-30 pb-20 md:pb-28 flex items-end">
                    <div id="hero-metadata" class="max-w-3xl w-full animate-slide-up">${getHeroContentHtml(heroItems[0])}</div>
                </div>
                <div class="absolute bottom-8 right-8 z-40 flex gap-2">
                    ${heroItems.map((_, i) => `<button onclick="manualSwitchHero(${i})" class="hero-dot w-1.5 h-1.5 rounded-full transition-all duration-300 ${i===0 ? 'bg-brand w-8' : 'bg-white/30 hover:bg-white'}"></button>`).join('')}
                </div>
            </div>
        `;
        const bannerContainer = document.getElementById('banner-carousel');
        bannerContainer.innerHTML = heroHtml;
        startHeroInterval();
    }

    // 2. TRENDING SECTION (Refined)
    const trendingContainer = document.createElement('div');
    trendingContainer.id = 'home-trending-wrapper';
    c.appendChild(trendingContainer);

    sb.from('movies').select('*')
      .order('views', { ascending: false, nullsLast: true })
      .order('created_at', { ascending: false })
      .limit(20).then(({ data }) => {
        if (data && data.length) {
            data.forEach(i => contentCache.set(String(i.id), { ...i, type: 'movie' }));
            const trendingHtml = `
                <div class="mb-10 mt-[-40px] relative z-40 pl-5 animate-fade-in">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ri-fire-fill text-brand"></i> Top Trending</h3>
                    <div class="flex overflow-x-auto gap-5 drag-scroll no-scrollbar pb-6">
                        ${data.slice(0, 10).map((m, i) => createRankCard(m, i+1)).join('')}
                    </div>
                </div>
            `;
            if (document.getElementById('home-trending-wrapper')) {
                document.getElementById('home-trending-wrapper').innerHTML = trendingHtml;
            }
        }
    });

    // 3. GENRE PILLS (Clean)
    const pillsHtml = `
        <div class="px-5 mb-8 overflow-x-auto no-scrollbar flex gap-3">
            <button onclick="showPage('categories-page')" class="px-5 py-2.5 rounded-xl bg-white/5 backdrop-blur-md text-white text-xs font-bold border border-white/5 hover:bg-white hover:text-black transition">All Genres</button>
            ${['Action','Sci-Fi','Drama','Horror','Comedy'].map(g => `<button onclick="quickSearchGenre('${g}')" class="px-5 py-2.5 rounded-xl bg-highlight text-gray-300 text-xs font-bold border border-white/5 hover:border-brand hover:text-white transition">${g}</button>`).join('')}
        </div>`;
    c.insertAdjacentHTML('beforeend', pillsHtml);

    // 4. RANDOM PICKS
    const randomWrapper = document.createElement('div');
    randomWrapper.id = 'random-picks-wrapper';
    c.appendChild(randomWrapper);
    renderRandomSection();

    // 5. RECENT MOVIES
    if (recentMovies.length) c.appendChild(createRow("New Releases", recentMovies));

    // 6. POPULAR STARS
    if (popularPeople.length) {
        c.insertAdjacentHTML('beforeend', `<div class="mb-8"><h3 class="text-lg font-bold text-white mb-3 px-5">Popular Stars</h3><div class="flex overflow-x-auto gap-4 drag-scroll no-scrollbar px-5 pb-2">${popularPeople.map(p => createCastCircle(p)).join('')}</div></div>`);
    }

    // 7. TV SHOWS
    if (recentSeries.length) c.appendChild(createRow("TV Shows", recentSeries));
}

async function renderRandomSection() {
    const { data: m } = await sb.from('movies').select('*').limit(20);
    const { data: s } = await sb.from('series').select('*').limit(20);
    let combined = [
        ...(m || []).map(i => ({...i, type: 'movie'})),
        ...(s || []).map(i => ({...i, type: 'series'}))
    ];
    combined = combined.sort(() => 0.5 - Math.random()).slice(0, 10);
    if(combined.length > 0) {
        combined.forEach(i => contentCache.set(String(i.id), i));
        const html = createRow("Mystery Picks", combined);
        const container = document.getElementById('random-picks-wrapper');
        if(container) container.appendChild(html);
    }
}

async function incrementViewCount(id, type) {
    const table = type === 'movie' ? 'movies' : 'series';
    try {
        const { data } = await sb.from(table).select('views').eq('id', id).single();
        let currentViews = (data && data.views) ? data.views : 0;
        await sb.from(table).update({ views: currentViews + 1 }).eq('id', id);
    } catch (e) {
        console.log("View tracking failed", e);
    }
}

function getHeroContentHtml(m) {
    const desc = m.description || m.synopsis || m.overview || 'Experience this amazing title. Stream now in HD.';
    return `
        <div class="inline-flex items-center gap-2 bg-brand/20 backdrop-blur-md border border-brand/30 text-brand text-[10px] font-black px-3 py-1 rounded mb-4 tracking-widest uppercase shadow-[0_0_15px_rgba(229,9,20,0.3)]">
            <i class="ri-award-fill"></i> Spotlight
        </div>
        <h1 class="text-4xl md:text-7xl font-black mb-4 text-white leading-none drop-shadow-2xl fade-in-text tracking-tight">${m.title}</h1>
        
        <div class="flex items-center gap-4 text-xs md:text-sm text-gray-300 mb-6 font-medium">
            <span class="text-green-400 font-bold flex items-center gap-1"><i class="ri-thumb-up-fill"></i> 98%</span>
            <span class="bg-white/10 px-2 py-0.5 rounded text-white border border-white/10">${m.year || '2025'}</span>
            <span class="bg-white/10 px-2 py-0.5 rounded text-white border border-white/10">HD</span>
            <span class="flex items-center gap-1 text-yellow-500"><i class="ri-star-fill"></i> ${m.rating || '8.5'}</span>
        </div>

        <p class="text-gray-300 text-sm md:text-lg line-clamp-3 mb-8 max-w-2xl drop-shadow-md leading-relaxed opacity-90 font-light">
            ${desc}
        </p>

        <div class="flex gap-4">
            <button onclick="openPlayerPage('${String(m.id)}','${m.type||'movie'}')" class="bg-white text-black px-6 md:px-10 py-3.5 rounded-xl font-bold flex items-center gap-2 hover:bg-gray-200 hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                <i class="ri-play-fill text-2xl"></i> Play Now
            </button>
            <button onclick="openPlayerPage('${String(m.id)}','${m.type||'movie'}');" class="bg-white/10 backdrop-blur-md text-white px-6 md:px-10 py-3.5 rounded-xl font-bold flex items-center gap-2 hover:bg-white/20 transition border border-white/10">
                <i class="ri-information-line text-2xl"></i> Info
            </button>
        </div>
    `;
}

function startHeroInterval() {
    if (heroTimer) clearInterval(heroTimer);
    heroTimer = setInterval(() => {
        let nextIndex = (currentHeroIndex + 1) % heroItems.length;
        changeHeroSlide(nextIndex);
    }, 8000);
}

function manualSwitchHero(index) {
    if (index === currentHeroIndex) return;
    clearInterval(heroTimer);
    changeHeroSlide(index);
    startHeroInterval();
}

function changeHeroSlide(index) {
    const slides = document.querySelectorAll('.hero-slide');
    const dots = document.querySelectorAll('.hero-dot');
    const contentContainer = document.getElementById('hero-metadata');
    slides[currentHeroIndex].classList.remove('opacity-100', 'z-10');
    slides[currentHeroIndex].classList.add('opacity-0', 'z-0');
    slides[index].classList.remove('opacity-0', 'z-0');
    slides[index].classList.add('opacity-100', 'z-10');
    dots[currentHeroIndex].classList.remove('bg-brand', 'w-8');
    dots[currentHeroIndex].classList.add('bg-white/30');
    dots[index].classList.remove('bg-white/30');
    dots[index].classList.add('bg-brand', 'w-8');
    contentContainer.style.opacity = '0';
    contentContainer.style.transform = 'translateY(10px)';
    setTimeout(() => {
        contentContainer.innerHTML = getHeroContentHtml(heroItems[index]);
        contentContainer.style.opacity = '1';
        contentContainer.style.transform = 'translateY(0)';
    }, 300);
    currentHeroIndex = index;
}

function quickSearchGenre(gName) {
    const genreMap = {
        'Action': 28, 'Sci-Fi': 878, 'Drama': 18, 'Horror': 27, 'Comedy': 35
    };
    const id = genreMap[gName];
    if (id) quickLoadGenre(id, gName, 'movie');
}

// --- UPDATED GENRE GRID (Clean, No Blur, Specific Images) ---
function renderGenreGrid() {
    // Specific high quality backdrops for genres
    const genreImages = {
        28: 'https://image.tmdb.org/t/p/w780/8pjWz2lt29KyVGoq1mXYu6Br7dE.jpg', // Action (Grey Man/Similar)
        12: 'https://image.tmdb.org/t/p/w780/kXfqcdQKsToO0OUXHcrrNCHDBzO.jpg', // Adventure (Shawshank/Similar)
        16: 'https://image.tmdb.org/t/p/w780/qJ60PNcQxZfR9A8f1aVvP9A8D6.jpg', // Animation
        35: 'https://image.tmdb.org/t/p/w780/8kOWDBK6XlPUzckuHDo3wwVRFwt.jpg', // Comedy
        80: 'https://image.tmdb.org/t/p/w780/l6hQWH9eDksNJNiXWYRkWqikOxr.jpg', // Crime
        99: 'https://image.tmdb.org/t/p/w780/xZ2X10c4K4p5d3B4G4n3J3K3.jpg', // Documentary
        18: 'https://image.tmdb.org/t/p/w780/hZkgoQYus5vegHoetLkCJzb17zJ.jpg', // Drama (Fight Club)
        10751: 'https://image.tmdb.org/t/p/w780/bOGkgRGdhrBYJSLpXaxhXVstddV.jpg', // Family
        14: 'https://image.tmdb.org/t/p/w780/p1F51Lvj3sMopG948F5HsBbl43C.jpg', // Fantasy (Thor)
        36: 'https://image.tmdb.org/t/p/w780/bQLrHIRGOB03B0f75e2N9F7w6f.jpg', // History
        27: 'https://image.tmdb.org/t/p/w780/uOz4ZtE9y0QyGG5B5D5F5E5.jpg', // Horror
        10402: 'https://image.tmdb.org/t/p/w780/lFwykSz3Ykj1Q3GXJ1Q3.jpg', // Music
        9648: 'https://image.tmdb.org/t/p/w780/5i6SjyDbDWqyun8klUuCxrlFbyw.jpg', // Mystery
        10749: 'https://image.tmdb.org/t/p/w780/xJWPZIYOEFIjZpBL7SVBGnzRYXp.jpg', // Romance
        878: 'https://image.tmdb.org/t/p/w780/9BBTo63ANSmhC4e6r62OJFuK2GL.jpg', // Sci-Fi (Avatar)
        10770: 'https://image.tmdb.org/t/p/w780/5A6lX02.jpg', // TV Movie (Fallback)
        53: 'https://image.tmdb.org/t/p/w780/dKqa850uvbNSCaQCV4Im1XlzEtQ.jpg', // Thriller (Glass Onion)
        10752: 'https://image.tmdb.org/t/p/w780/hT9xuEi0PSpJ7JHe1.jpg', // War
        37: 'https://image.tmdb.org/t/p/w780/iQd1.jpg', // Western
        10765: 'https://image.tmdb.org/t/p/w780/1SDyS1C.jpg' // Sci-Fi & Fantasy TV
    };

    const genres = [
        {id: 28, name: 'Action', type: 'movie'}, {id: 12, name: 'Adventure', type: 'movie'},
        {id: 16, name: 'Animation', type: 'movie'}, {id: 35, name: 'Comedy', type: 'movie'},
        {id: 80, name: 'Crime', type: 'movie'}, {id: 99, name: 'Documentary', type: 'movie'},
        {id: 18, name: 'Drama', type: 'movie'}, {id: 10751, name: 'Family', type: 'movie'},
        {id: 14, name: 'Fantasy', type: 'movie'}, {id: 36, name: 'History', type: 'movie'},
        {id: 27, name: 'Horror', type: 'movie'}, {id: 10402, name: 'Music', type: 'movie'},
        {id: 9648, name: 'Mystery', type: 'movie'}, {id: 10749, name: 'Romance', type: 'movie'},
        {id: 878, name: 'Sci-Fi', type: 'movie'}, {id: 10770, name: 'TV Movie', type: 'movie'},
        {id: 53, name: 'Thriller', type: 'movie'}, {id: 10752, name: 'War', type: 'movie'},
        {id: 37, name: 'Western', type: 'movie'}, {id: 10765, name: 'Sci-Fi & Fantasy', type: 'tv'}
    ];
    
    const container = document.getElementById('genre-grid-container');
    container.innerHTML = genres.map(g => {
        const bg = genreImages[g.id] || 'https://image.tmdb.org/t/p/w780/8pjWz2lt29KyVGoq1mXYu6Br7dE.jpg';
        return `
        <div onclick="quickLoadGenre(${g.id}, '${g.name}', '${g.type}')" class="genre-card relative h-28 md:h-36 rounded-xl overflow-hidden cursor-pointer group bg-highlight">
            <img src="${bg}" class="absolute inset-0 w-full h-full object-cover transition duration-700 z-0 opacity-80 group-hover:opacity-100 group-hover:scale-110">
            <div class="absolute inset-0 bg-black/40 z-10 group-hover:bg-black/20 transition"></div>
            <h3 class="genre-title text-white z-20">${g.name}</h3>
        </div>
    `}).join('');
}

async function fetchPaginatedContent(type, isLoadMore = false) {
    const state = type === 'movie' ? pageState.movies : pageState.series;
    const container = document.getElementById(type === 'movie' ? 'movies-content' : 'series-content');
    const loader = document.getElementById(type === 'movie' ? 'movies-loader' : 'series-loader');
    const btn = document.getElementById(type === 'movie' ? 'movies-more-btn' : 'series-more-btn');
    if (pageState.isLoading) return;
    pageState.isLoading = true;
    if (!isLoadMore) container.innerHTML = '';
    loader.classList.remove('hidden');
    btn.classList.add('hidden');
    const table = type === 'movie' ? 'movies' : 'series';
    const {
        data,
        error
    } = await sb.from(table).select('*').order('created_at', {
        ascending: false,
        nullsFirst: false
    }).range(state.offset, state.offset + state.limit - 1);
    loader.classList.add('hidden');
    pageState.isLoading = false;
    if (data && data.length > 0) {
        const mapped = data.map(i => {
            const obj = {
                ...i,
                type: type,
                timestamp: new Date(i.created_at).getTime()
            };
            contentCache.set(String(i.id), obj);
            return obj;
        });
        container.insertAdjacentHTML('beforeend', mapped.map(m => createPosterCard(m, false)).join(''));
        state.offset += state.limit;
        if (data.length === state.limit) btn.classList.remove('hidden');
    } else if (!isLoadMore) {
        container.innerHTML = '<p class="col-span-full text-center text-gray-500 mt-10">No content found in library.</p>';
    }
}

async function fetchTMDBPaginated(isLoadMore = false) {
    const container = document.getElementById(pageState.activePage === 'categories-page' ? 'category-tmdb-results' : 'search-results-tmdb');
    const btn = document.getElementById('category-load-more');
    const loader = document.getElementById('category-loader');
    
    if (pageState.isLoading) return;
    pageState.isLoading = true;
    
    if (!isLoadMore) {
        container.innerHTML = '';
        if(loader) loader.classList.remove('hidden');
    }

    const endpoint = pageState.tmdb.type === 'tv' ? 'discover/tv' : 'discover/movie';
    const url = `https://api.themoviedb.org/3/${endpoint}?api_key=${TMDB_API_KEY}&with_genres=${pageState.tmdb.genreId}&page=${pageState.tmdb.page}&sort_by=popularity.desc`;
    const res = await fetch(url);
    const data = await res.json();
    
    pageState.isLoading = false;
    if(loader) loader.classList.add('hidden');

    if (data.results && data.results.length > 0) {
        container.insertAdjacentHTML('beforeend', data.results.filter(m => m.poster_path).map(m => {
            m.media_type = pageState.tmdb.type;
            return createTMDBRequestCard(m);
        }).join(''));
        pageState.tmdb.page++;
        btn.classList.remove('hidden');
    } else {
        btn.classList.add('hidden');
    }
}

function loadNextPage() {
    if (pageState.activePage === 'movies-page') fetchPaginatedContent('movie', true);
    else if (pageState.activePage === 'series-page') fetchPaginatedContent('series', true);
    else if (pageState.activePage === 'categories-page') fetchTMDBPaginated(true);
}

function showPage(id) {
    if (id === 'mylist-page' && !currentUser) return openAuthModal();
    pageState.activePage = id;

    document.querySelectorAll('.nav-btn').forEach(btn => btn.dataset.page === id ? btn.classList.replace('text-gray-500', 'text-white') : btn.classList.replace('text-white', 'text-gray-500'));

    document.querySelectorAll('.page').forEach(p => {
        if (p.id !== 'player-page' && p.id !== 'actor-page') { // Ignore actor page
            p.classList.remove('active');
            p.style.opacity = 0;
        }
    });

    if (id === 'player-page') document.getElementById('player-page').classList.add('active');
    else {
        document.getElementById('player-page').classList.remove('active');
        document.getElementById('actor-page').classList.remove('active'); // Ensure actor page is closed
        const target = document.getElementById(id);
        target.classList.add('active');
        setTimeout(() => target.style.opacity = 1, 50);

        if (window.location.pathname.startsWith('/movie') || window.location.pathname.startsWith('/series')) {
            if (id === 'home-page') updateHistoryState('/');
        }
    }

    window.scrollTo(0, 0);
    document.getElementById('global-search-overlay').classList.remove('open');
    if (id === 'movies-page') {
        pageState.movies.offset = 0;
        renderMoviesHero();
        fetchPaginatedContent('movie');
    } else if (id === 'series-page') {
        pageState.series.offset = 0;
        renderSeriesHero();
        fetchPaginatedContent('series');
    } else if (id === 'categories-page') {
        document.getElementById('category-search-container').classList.add('hidden');
        document.getElementById('genre-header').classList.add('hidden');
        document.getElementById('category-tmdb-results').innerHTML = '';
        document.getElementById('category-load-more').classList.add('hidden');
        renderGenreGrid();
    } else if (id === 'mylist-page') {
        renderMyList();
    }
}

function handleListClick() {
    !currentUser ? openAuthModal() : showPage('mylist-page');
}
document.querySelectorAll('.nav-btn').forEach(b => {
    if (b.dataset.page !== 'mylist-page') b.addEventListener('click', () => showPage(b.dataset.page));
});

async function renderMyList() {
    if (!userFavorites.length) {
        document.getElementById('mylist-grid').innerHTML = '<p class="col-span-full text-center text-gray-500">Your list is empty.</p>';
        return;
    }
    document.getElementById('mylist-count').textContent = userFavorites.length;
    const missingIds = userFavorites.map(String).filter(id => !contentCache.has(id));
    if (missingIds.length > 0) {
        const {
            data: movies
        } = await sb.from('movies').select('*').in('id', missingIds);
        const {
            data: series
        } = await sb.from('series').select('*').in('id', missingIds);
        [...(movies || []), ...(series || [])].forEach(i => contentCache.set(String(i.id), {
            ...i,
            type: i.seasons ? 'series' : 'movie'
        }));
    }
    const favItems = userFavorites.map(id => contentCache.get(String(id))).filter(Boolean);
    document.getElementById('mylist-grid').innerHTML = favItems.map(m => createPosterCard(m, false)).join('');
}

function quickLoadGenre(id, name, type) {
    showPage('categories-page');
    loadGenreContent(id, name, type);
    setTimeout(() => {
        document.getElementById('category-search-container').scrollIntoView({
            behavior: 'smooth'
        });
    }, 300);
}

function loadGenreContent(genreId, genreName, genreType) {
    document.getElementById('selected-genre-title').innerText = genreName;
    document.getElementById('genre-header').classList.remove('hidden');
    document.getElementById('category-search-container').classList.remove('hidden');
    pageState.tmdb = {
        page: 1,
        genreId: genreId,
        type: genreType
    };
    fetchTMDBPaginated(false);
}

function toggleSearchOverlay() {
    const overlay = document.getElementById('global-search-overlay');
    overlay.classList.toggle('open');
    if (overlay.classList.contains('open')) {
        document.getElementById('global-search-input').focus();
    }
}

let searchDebounce;
document.getElementById('global-search-input').addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    clearTimeout(searchDebounce);
    const localSec = document.getElementById('search-section-local'),
        tmdbSec = document.getElementById('search-section-tmdb'),
        loader = document.getElementById('search-loader');
    if (query.length < 2) {
        localSec.classList.add('hidden');
        tmdbSec.classList.add('hidden');
        return;
    }
    loader.classList.remove('hidden');
    searchDebounce = setTimeout(async () => {
        const {
            data: movies
        } = await sb.from('movies').select('*').ilike('title', `%${query}%`).limit(10);
        const {
            data: series
        } = await sb.from('series').select('*').ilike('title', `%${query}%`).limit(10);
        const dbResults = [...(movies || []).map(m => ({
            ...m,
            type: 'movie'
        })), ...(series || []).map(s => ({
            ...s,
            type: 'series'
        }))];
        dbResults.forEach(i => contentCache.set(String(i.id), i));
        loader.classList.add('hidden');
        if (dbResults.length > 0) {
            localSec.classList.remove('hidden');
            document.getElementById('search-results-local').innerHTML = dbResults.map(m => createPosterCard(m, false)).join('');
        } else {
            localSec.classList.add('hidden');
        }
        tmdbSec.classList.remove('hidden');
        fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`).then(res => res.json()).then(data => {
            const validResults = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
            document.getElementById('search-results-tmdb').innerHTML = validResults.length ? validResults.map(m => createTMDBRequestCard(m)).join('') : `<p class="col-span-full text-gray-500 text-center text-sm">No matches found on TMDB.</p>`;
        });
    }, 600);
});

// --- NEW ACTOR SYSTEM & PAGE ---

async function openActorPage(id) {
    if (!id) return;
    document.getElementById('global-search-overlay').classList.remove('open');
    document.getElementById('actor-page').classList.remove('hidden');
    document.getElementById('actor-page').style.opacity = '1';
    
    // Reset state
    pageState.actor = { id: id, credits: [], offset: 0, limit: 5, isLoading: false };
    document.getElementById('actor-credits-grid').innerHTML = '';
    document.getElementById('actor-scroll-trigger').innerHTML = '<div class="content-loader"></div>';

    // Fetch details
    const res = await fetch(`https://api.themoviedb.org/3/person/${id}?api_key=${TMDB_API_KEY}`);
    const details = await res.json();
    
    const creditsRes = await fetch(`https://api.themoviedb.org/3/person/${id}/combined_credits?api_key=${TMDB_API_KEY}`);
    const creditsData = await creditsRes.json();
    
    // Sort credits by popularity and filter with posters
    pageState.actor.credits = (creditsData.cast || [])
        .filter(c => c.poster_path)
        .sort((a,b) => b.popularity - a.popularity);

    // Render Header
    document.getElementById('actor-name').innerText = details.name;
    document.getElementById('actor-bio').innerText = details.biography || "No biography available.";
    document.getElementById('actor-dob').innerText = details.birthday ? `Born: ${details.birthday}` : '';
    document.getElementById('actor-place').innerText = details.place_of_birth || '';
    
    if(details.profile_path) {
        document.getElementById('actor-cover-image').src = `https://image.tmdb.org/t/p/w1280${details.profile_path}`;
    } else {
        document.getElementById('actor-cover-image').src = `https://ui-avatars.com/api/?name=${details.name}&background=111&color=333&size=512`;
    }

    // Initial Load of 5
    renderActorCredits();
}

function closeActorPage() {
    const p = document.getElementById('actor-page');
    p.style.opacity = '0';
    setTimeout(() => p.classList.add('hidden'), 300);
}

function renderActorCredits() {
    const { credits, offset, limit } = pageState.actor;
    const container = document.getElementById('actor-credits-grid');
    const trigger = document.getElementById('actor-scroll-trigger');

    // Slice batch
    const batch = credits.slice(offset, offset + limit);
    
    if(batch.length > 0) {
        container.insertAdjacentHTML('beforeend', batch.map(c => createTMDBRequestCard(c)).join(''));
        pageState.actor.offset += limit;
    }

    // Check if end reached
    if(pageState.actor.offset >= credits.length) {
        // Append REQUEST CARD at the end
        const reqHtml = `
            <div onclick="openRequestModal({title: 'More Content for ${document.getElementById('actor-name').innerText}', id: 'custom', media_type: 'custom'})" class="aspect-[2/3] rounded-lg border-2 border-dashed border-white/20 flex flex-col items-center justify-center cursor-pointer hover:border-brand hover:bg-white/5 transition group">
                <i class="ri-add-circle-line text-4xl text-gray-500 group-hover:text-brand mb-2"></i>
                <p class="text-xs text-gray-400 font-bold uppercase text-center px-2">Request More</p>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', reqHtml);
        trigger.innerHTML = '<p class="text-gray-500 text-xs">End of list</p>';
    } else {
        // Keep loader for observer
        trigger.innerHTML = '<div class="content-loader"></div>';
    }
}

function setupActorScrollObserver() {
    const trigger = document.getElementById('actor-scroll-trigger');
    const observer = new IntersectionObserver((entries) => {
        if(entries[0].isIntersecting && !document.getElementById('actor-page').classList.contains('hidden')) {
            if(pageState.actor.offset < pageState.actor.credits.length) {
                // Simulate small network delay for smooth feel
                setTimeout(() => renderActorCredits(), 500);
            }
        }
    }, { rootMargin: '100px' });
    
    observer.observe(trigger);
}


async function openPlayerPage(id, type, preventHistoryUpdate = false) {
    incrementViewCount(id, type);
    const safeId = String(id);
    let item = contentCache.get(safeId);
    if (!item || !item.description) {
        const table = type === 'movie' ? 'movies' : 'series';
        const {
            data,
            error
        } = await sb.from(table).select('*').eq('id', safeId).single();
        if (data) {
            item = {
                ...data,
                type: type
            };
            contentCache.set(safeId, item);
        } else {
            return showNotification("Content not found", "error");
        }
    }
    currentOpenId = safeId;
    currentSeriesData = item;
    activeServerList = [];
    activeServerIndex = 0;

    if (!preventHistoryUpdate) {
        const slug = createSlug(item.title);
        const newUrl = type === 'movie' ?
            `/movie/${item.id}/${slug}` :
            `/series/${item.id}/${slug}`;
        updateHistoryState(newUrl);
    }

    let history = JSON.parse(localStorage.getItem('watchHistory')) || [];
    history = history.filter(i => String(i.id) !== safeId);
    history.unshift({
        id: item.id,
        type: item.type,
        title: item.title,
        poster: item.thumbnail || item.poster,
        timestamp: Date.now()
    });
    if (history.length > 10) history.pop();
    localStorage.setItem('watchHistory', JSON.stringify(history));

    const isSeries = item.type === 'series';
    const isFav = userFavorites.map(String).includes(safeId);
    const qualityTag = item.quality || 'HD';
    const qualityColor = qualityTag === '4K' ? 'text-brand border-brand' : 'text-gray-300 border-gray-500';

    document.getElementById('player-meta').innerHTML = `<h1 class="text-2xl md:text-4xl font-black text-white mb-2">${item.title}</h1><div class="flex items-center gap-3 text-sm text-gray-400 mb-4"><span class="text-green-500 font-bold">98% Match</span>${isSeries ? '<span class="bg-highlight border border-white/10 px-2 py-0.5 rounded text-xs text-white">SERIES</span>' : `<span class="border ${qualityColor} px-1.5 rounded text-xs font-bold">${qualityTag}</span>`}<span class="text-gray-500 text-xs">${item.year || ''}</span><button onclick="reportIssue('${item.id}', '${item.title}')" class="flex items-center gap-1 hover:text-white transition bg-highlight px-3 py-1 rounded-full border border-white/10 ml-2"><i class="ri-flag-fill text-yellow-500 text-lg"></i></button><button id="fav-btn" onclick="toggleFavorite('${item.id}')" class="flex items-center gap-1 ${isFav?'text-brand':''} hover:text-white transition ml-auto bg-highlight px-3 py-1 rounded-full"><i id="fav-icon" class="${isFav?'ri-check-line':'ri-add-line'} text-lg"></i></button></div><p class="text-gray-300 text-sm leading-relaxed mb-4">${item.description||'No description available.'}</p><div class="text-xs text-gray-500">Genre: <span class="text-gray-300">${item.genre}</span></div>`;

    const dl = document.getElementById('downloads-list');
    if (!isSeries && item.downloads) dl.innerHTML = item.downloads.map(d => `<a href="${d.link}" target="_blank" class="flex items-center justify-between p-4 bg-highlight/30 rounded-lg border border-white/5 hover:bg-highlight/50 hover:border-brand transition group"><div><div class="font-bold text-white text-sm group-hover:text-brand">Download ${d.title}</div><div class="text-[10px] text-gray-500">Server Link</div></div><i class="ri-download-cloud-2-line text-xl text-gray-400 group-hover:text-white"></i></a>`).join('');
    else dl.innerHTML = isSeries ? `<div class="text-center text-gray-500 text-sm py-4">Downloads available via Episodes tab</div>` : `<div class="text-center text-gray-500 text-sm py-4">No downloads available</div>`;

    const et = document.getElementById('tab-episodes'),
        ss = document.getElementById('season-select');
    document.getElementById('video-area').innerHTML = `<div class="video-wrapper relative"><div id="player-placeholder" class="absolute inset-0 w-full h-full"><img src="${item.thumbnail||item.poster}" class="w-full h-full object-cover opacity-60"><div class="absolute inset-0 flex items-center justify-center"><div class="w-20 h-20 bg-brand rounded-full flex items-center justify-center text-white shadow-[0_0_40px_rgba(229,9,20,0.6)]"><i class="ri-play-fill text-4xl ml-1"></i></div></div></div></div>`;
    
    document.getElementById('server-trigger-bar').classList.add('hidden');
    document.getElementById('player-controls-container').classList.add('hidden');

    const primaryGenre = item.genre ? item.genre.split(',')[0].trim() : '';
    pageState.similar = {
        offset: 0,
        limit: 15,
        genre: primaryGenre,
        type: item.type,
        excludeId: item.id
    };
    document.getElementById('similar-grid').innerHTML = '';
    document.getElementById('similar-load-more-btn').classList.add('hidden');
    fetchSimilarContent();

    if (isSeries) {
        et.classList.remove('hidden');
        const seasonContainer = document.getElementById('season-selector-container');
        let firstEp = null;

        if (item.seasons && item.seasons.length > 0) {
            seasonContainer.classList.remove('hidden');
            ss.innerHTML = item.seasons.map((s, i) => `<option value="${i}">${s.name}</option>`).join('');
            renderEpisodes(0);
            if (item.seasons[0].episodes && item.seasons[0].episodes.length > 0) firstEp = item.seasons[0].episodes[0];
        } else if (item.episodes && item.episodes.length > 0) {
            seasonContainer.classList.remove('hidden');
            ss.innerHTML = `<option value="flat">Season 1</option>`;
            renderEpisodes('flat');
            firstEp = item.episodes[0];
        } else {
            seasonContainer.classList.add('hidden');
            document.getElementById('episodes-list').innerHTML = '<div class="text-gray-500 text-center py-4">No episodes available</div>';
        }

        switchTab('episodes');
        if (firstEp && !preventHistoryUpdate) {
            let epServers = firstEp.servers || [];
            if ((!epServers || epServers.length === 0) && firstEp.link) epServers = [{
                name: "Server 1",
                url: firstEp.link
            }];
            const epData = {
                title: firstEp.title || `Episode 1`,
                servers: epServers,
                downloadLink: firstEp.downloadLink
            };
            playEpisode(encodeURIComponent(JSON.stringify(epData)), 0);
        }
    } else {
        document.getElementById('season-selector-container').classList.add('hidden');
        et.classList.add('hidden');
        if (item.servers && Array.isArray(item.servers) && item.servers.length > 0) activeServerList = item.servers;
        else if (item.watchLink) activeServerList = [{
            name: "Server 1",
            url: item.watchLink
        }];
        else if (item.link) activeServerList = [{
            name: "Server 1",
            url: item.link
        }];

        if (activeServerList.length > 0) {
            document.getElementById('server-trigger-bar').classList.remove('hidden');
            selectServerFromModal(0);
        } else document.getElementById('current-server-name').innerText = "No Servers";

        switchTab('similar');
    }
    loadComments(safeId);
    showPage('player-page');
}

async function fetchSimilarContent(isLoadMore = false) {
    if (pageState.isLoading) return;
    pageState.isLoading = true;
    const loader = document.getElementById('similar-loader');
    const btn = document.getElementById('similar-load-more-btn');
    const container = document.getElementById('similar-grid');
    if (!isLoadMore) container.innerHTML = '';
    loader.classList.remove('hidden');
    btn.classList.add('hidden');
    const table = pageState.similar.type === 'movie' ? 'movies' : 'series';

    let query = sb.from(table).select('*');
    if (pageState.similar.genre) {
        query = query.ilike('genre', `%${pageState.similar.genre}%`);
    }
    const {
        data,
        error
    } = await query
        .neq('id', pageState.similar.excludeId)
        .order('created_at', {
            ascending: false,
            nullsFirst: false
        })
        .range(pageState.similar.offset, pageState.similar.offset + pageState.similar.limit - 1);

    loader.classList.add('hidden');
    pageState.isLoading = false;
    if (data && data.length > 0) {
        const mapped = data.map(i => {
            const obj = {
                ...i,
                type: pageState.similar.type,
                timestamp: new Date(i.created_at).getTime()
            };
            contentCache.set(String(i.id), obj);
            return obj;
        });
        container.insertAdjacentHTML('beforeend', mapped.map(m => createPosterCard(m, false)).join(''));
        pageState.similar.offset += pageState.similar.limit;
        if (data.length === pageState.similar.limit) btn.classList.remove('hidden');
    } else if (!isLoadMore && pageState.similar.offset === 0) {
        container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No similar content found.</p>';
    }
}

function loadNextSimilarPage() {
    fetchSimilarContent(true);
}

function createPosterCard(m, isLandscape) {
    return `<div onclick="openPlayerPage('${m.id}','${m.type}')" class="cursor-pointer transition hover:scale-105 duration-300 relative group animate-fade-in"><div class="${isLandscape ? 'aspect-video' : 'aspect-[2/3]'} rounded-lg overflow-hidden bg-surface border border-white/10 relative"><img src="${m.poster}" class="w-full h-full object-cover" loading="lazy">${m.type==='series'?'<span class="absolute top-1 right-1 bg-black/60 text-[9px] text-white px-1 rounded font-bold tracking-wider">TV</span>':''}</div><h4 class="text-xs font-medium mt-2 truncate text-gray-400 group-hover:text-white">${m.title}</h4></div>`;
}

function createRankCard(m, rank) {
    return `<div onclick="openPlayerPage('${m.id}','${m.type}')" class="flex-none w-36 md:w-44 cursor-pointer relative group pl-5"><div class="aspect-[2/3] rounded-lg overflow-hidden border border-white/10 rank-card-image transition hover:scale-105 duration-300"><img src="${m.poster}" class="w-full h-full object-cover"></div><div class="rank-number">${rank}</div></div>`;
}

// --- UPDATED CAST CIRCLE TO OPEN ACTOR PAGE ---
function createCastCircle(person) {
    return `<div onclick="openActorPage('${person.id}')" class="flex-none w-20 flex flex-col items-center gap-2 cursor-pointer group"><div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white/10 group-hover:border-brand transition"><img src="https://image.tmdb.org/t/p/w185${person.profile_path}" class="w-full h-full object-cover"></div><p class="text-[10px] text-center text-gray-400 group-hover:text-white truncate w-full">${person.name}</p></div>`;
}

function createRow(title, items) {
    const div = document.createElement('div');
    div.innerHTML = `<div class="flex justify-between items-end mb-4 px-5"><h3 class="text-lg font-bold text-white capitalize">${title}</h3></div><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 px-5 pb-4">${items.map(m => `<div onclick="openPlayerPage('${m.id}','${m.type}')" class="cursor-pointer group relative transition hover:scale-105 duration-300"><div class="aspect-[2/3] rounded-lg overflow-hidden bg-surface shadow-lg border border-white/5"><img src="${m.poster}" class="w-full h-full object-cover" loading="lazy"></div><h4 class="text-xs font-medium mt-2 truncate text-gray-400 group-hover:text-white">${m.title}</h4></div>`).join('')}</div>`;
    return div;
}

function createTMDBRequestCard(item) {
    const title = item.title || item.name;
    const existing = Array.from(contentCache.values()).find(c => c.title.toLowerCase() === title.toLowerCase());
    const itemData = JSON.stringify({
        ...item,
        media_type: item.media_type || 'movie'
    }).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
    if (existing) return createPosterCard(existing, false);
    
    // Check if poster exists
    const poster = item.poster_path ? `https://image.tmdb.org/t/p/w342${item.poster_path}` : 'https://placehold.co/342x513/111/444?text=No+Poster';

    return `<div class="relative group cursor-pointer rounded-lg overflow-hidden border border-white/10 aspect-[2/3] tmdb-card"><img src="${poster}" class="w-full h-full object-cover"><button onclick='openRequestModal(${itemData})' class="absolute inset-0 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition bg-black/80"><div class="w-12 h-12 rounded-full bg-highlight flex items-center justify-center mb-2 text-brand"><i class="ri-send-plane-fill text-xl"></i></div><span class="text-[10px] font-bold text-white uppercase">Request</span></button><div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black p-2"><p class="text-[10px] text-gray-300 truncate">${title}</p></div></div>`;
}

function setupAuthListener() {
    sb.auth.onAuthStateChange((event, session) => {
        currentUser = session?.user || null;
        if (currentUser) {
            closeAuthModal();
            document.getElementById('auth-view-guest').classList.add('hidden');
            document.getElementById('auth-view-user').classList.remove('hidden');
            document.getElementById('user-email-display').textContent = currentUser.email;
            document.getElementById('user-icon').classList.add('hidden');
            document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${currentUser.email}&background=E50914&color=fff`;
            document.getElementById('user-avatar').classList.remove('hidden');
            fetchUserProfile();
        } else {
            userFavorites = [];
            document.getElementById('user-avatar').classList.add('hidden');
            document.getElementById('user-icon').classList.remove('hidden');
            document.getElementById('auth-view-guest').classList.remove('hidden');
            document.getElementById('auth-view-user').classList.add('hidden');
            document.getElementById('mylist-count').textContent = 0;
        }
    });
    sb.auth.getSession().then(({
        data: {
            session
        }
    }) => {
        if (session?.user) {
            currentUser = session.user;
            fetchUserProfile();
        }
    });
}

function fetchUserProfile() {
    if (!currentUser) return;
    sb.from('profiles').select('favorites').eq('id', currentUser.id).single().then(({
        data
    }) => {
        if (data && data.favorites) {
            userFavorites = data.favorites;
            document.getElementById('mylist-count').textContent = userFavorites.length;
        } else {
            userFavorites = [];
        }
    });
}
async function handleSignOut() {
    await sb.auth.signOut();
    window.location.reload();
}
let pendingRequestItem = null;

function openRequestModal(item) {
    if (!currentUser) {
        showNotification("Login to request", "error");
        return openAuthModal();
    }
    pendingRequestItem = item;
    document.getElementById('confirm-modal-text').innerHTML = `You are about to request <b>"${item.title || item.name}"</b>.`;
    document.getElementById('custom-confirm-modal').classList.remove('hidden');
}

function closeConfirmModal() {
    document.getElementById('custom-confirm-modal').classList.add('hidden');
    pendingRequestItem = null;
}

// --- UPDATED REQUEST LOGIC (Rate Limiting & Notifications) ---
document.getElementById('confirm-action-btn').addEventListener('click', () => {
    if (!pendingRequestItem || !currentUser) return;
    
    // 1. Rate Limiting Check
    const now = Date.now();
    // Filter timestamps older than 60 seconds
    requestTimestamps = requestTimestamps.filter(ts => now - ts < 60000);
    
    if (requestTimestamps.length >= 3) {
        showNotification("Whoa there! Speed limit reached. Chill for a minute.", "info");
        closeConfirmModal();
        return;
    }

    const item = pendingRequestItem;
    sb.from('requests').insert({
        tmdb_id: String(item.id),
        title: item.title || item.name,
        type: item.media_type === 'tv' ? 'Series' : 'Movie',
        poster: item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '',
        requested_by: currentUser.email,
        status: 'pending'
    }).then(({
        error
    }) => {
        if (error) {
            if (error.message.includes('unique') || error.message.includes('duplicate')) {
                showNotification("Request already exists. We're working on it!", "info");
            } else {
                showNotification("Error sending request.", "error");
            }
        } else {
            requestTimestamps.push(now); // Log timestamp
            showNotification("Request Granted! We'll add it soon.", "success");
        }
        closeConfirmModal();
    });
});

async function reportIssue(id, title) {
    if (!currentUser) {
        showNotification("Login to report issues", "error");
        return openAuthModal();
    }
    if (confirm(`Report playback issue for "${title}"?`)) {
        const {
            error
        } = await sb.from('reports').insert({
            content_id: id,
            title: title,
            type: 'Dead Link',
            requested_by: currentUser.email
        });
        if (error) showNotification("Error sending report", "error");
        else showNotification("Report sent! We'll fix it soon.", "success");
    }
}

function openLegalModal(type) {
    const texts = {
        dmca: `<h3>DMCA & Copyright</h3>
               <p class="mb-2">MultiFlix operates strictly as a search engine and does not host any files on its servers. We only index links found on the public internet, just like Google.</p>
               <p class="mb-2">We fully respect intellectual property rights. If you are a copyright owner and believe your content is being infringed, please contact us with proof of ownership.</p>
               <p class="mb-4 font-bold text-white">We guarantee that valid infringing content will be immediately removed upon verification of proof.</p>
               <div class="bg-white/5 p-3 rounded-lg border border-white/10 text-center">
                   <p class="text-xs text-gray-400 uppercase font-bold mb-1">Official Contact</p>
                   <a href="mailto:multiflix@outlook.com" class="text-brand text-lg font-bold hover:underline">multiflix@outlook.com</a>
               </div>`,
        privacy: `<h3>Privacy Policy</h3>
                  <p class="mb-2">We believe in full transparency. We do not sell your personal data to third parties.</p>
                  <p>We only collect minimal information (such as your email for login) strictly to provide our services and improve your user experience.</p>`
    };
    document.getElementById('legal-modal-title').innerText = type === 'dmca' ? 'DMCA' : 'Privacy Policy';
    document.getElementById('legal-modal-body').innerHTML = texts[type];
    document.getElementById('legal-modal').classList.remove('hidden');
}

function closeLegalModal() {
    document.getElementById('legal-modal').classList.add('hidden');
}

function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    let bgClass = "bg-highlight",
        icon = "ri-notification-3-line";
    if (type === 'success') {
        bgClass = "bg-green-900/90 border-green-500";
        icon = "ri-check-double-line";
    }
    if (type === 'error') {
        bgClass = "bg-red-900/90 border-red-500";
        icon = "ri-error-warning-line";
    }
    const toast = document.createElement('div');
    toast.className = `pointer-events-auto w-72 p-4 rounded-xl border ${bgClass} text-white shadow-2xl backdrop-blur-md toast-enter flex items-start gap-3`;
    toast.innerHTML = `<div class="mt-1"><i class="${icon} text-xl"></i></div><div class="flex-1"><h4 class="text-sm font-bold mb-1">Notification</h4><p class="text-xs text-gray-200 leading-snug">${message}</p></div>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 500);
    }, 5000);
}

function renderMoviesHero() {
    if (contentCache.size > 0) {
        const m = Array.from(contentCache.values()).find(x => x.type === 'movie');
        if (m) {
            document.getElementById('movies-hero-img').src = m.thumbnail || m.poster;
            document.getElementById('movies-hero-img').onload = function() {
                this.style.opacity = 1;
                document.querySelector('#movies-banner .skeleton').style.display = 'none';
            };
        }
    }
}

function renderSeriesHero() {
    if (contentCache.size > 0) {
        const s = Array.from(contentCache.values()).find(x => x.type === 'series');
        if (s) {
            document.getElementById('series-hero-img').src = s.thumbnail || s.poster;
            document.getElementById('series-hero-img').onload = function() {
                this.style.opacity = 1;
                document.querySelector('#series-banner .skeleton').style.display = 'none';
            };
        }
    }
}

// --- UPDATED RENDER EPISODES (Dynamic Placeholders) ---
function renderEpisodes(idx) {
    const item = currentSeriesData;
    if (!item) return;

    let eps = [];
    let seasonIndexForKey = 1;

    if (idx === 'flat' || !item.seasons || item.seasons.length === 0) {
        eps = item.episodes || [];
        seasonIndexForKey = 1;
    } else {
        const seasonIndex = parseInt(idx);
        seasonIndexForKey = seasonIndex + 1;
        if (item.seasons[seasonIndex]) {
            eps = item.seasons[seasonIndex].episodes;
        }
    }

    if (!eps || eps.length === 0) {
        document.getElementById('episodes-list').innerHTML = '<div class="text-center text-gray-500 py-4">No episodes found for this selection.</div>';
        return;
    }

    document.getElementById('episodes-list').innerHTML = eps.map((ep, i) => {
        let epServers = [];

        const hasDirectLink = ep.link && typeof ep.link === 'string' && ep.link.trim() !== "";
        const hasServerArray = ep.servers && Array.isArray(ep.servers) && ep.servers.length > 0;

        if (hasServerArray) epServers = ep.servers;
        else if (hasDirectLink) epServers = [{
            name: "Server 1",
            url: ep.link
        }];

        const isAvailable = hasDirectLink || hasServerArray;

        const epData = {
            title: ep.title || `Episode ${i+1}`,
            servers: epServers,
            downloadLink: ep.downloadLink
        };
        const encodedData = encodeURIComponent(JSON.stringify(epData));
        
        // --- IMAGE LOGIC (PREVENT REPETITION) ---
        let imageHtml = '';
        if (ep.still && ep.still !== "") {
            imageHtml = `<img src="${ep.still}" loading="lazy">`;
        } else {
            // Generate CSS Placeholder
            imageHtml = `<div class="w-full h-full bg-gradient-to-br from-gray-800 to-black flex items-center justify-center border border-white/5"><span class="text-3xl font-black text-white/10 select-none">${i+1}</span></div>`;
        }

        let lockedClass = "";
        let clickAction = "";

        if (isAvailable) {
            lockedClass = "";
            clickAction = `playEpisode('${encodedData}', ${i})`;
        } else {
            lockedClass = "locked";
            clickAction = `showNotification('Coming soon, be patient', 'error')`;
        }

        const watchedKey = `watched-${item.id}-s${seasonIndexForKey}-e${i+1}`;
        const isWatched = localStorage.getItem(watchedKey) === 'true';
        const eyeColor = isWatched ? 'text-green-500' : 'text-gray-600 hover:text-white';
        const eyeIcon = isWatched ? 'ri-eye-fill' : 'ri-eye-line';

        return `
            <div id="ep-card-${i}" class="ep-card-container group ${lockedClass}" onclick="${clickAction}">
                <div class="ep-thumb-wrapper">
                    ${imageHtml}
                </div>
                <div class="ep-info flex-1">
                    <div class="ep-title-row justify-between">
                        <div class="flex items-center gap-2">
                            <span class="ep-number">${i+1}.</span>
                            <span class="ep-title">${ep.title || `Episode ${i+1}`}</span>
                        </div>
                        <button onclick="event.stopPropagation(); toggleWatched('${item.id}', ${seasonIndexForKey}, ${i+1}, this)" class="${eyeColor} text-xl p-2 transition">
                            <i class="${eyeIcon}"></i>
                        </button>
                    </div>
                    <p class="ep-desc">${ep.overview || item.title + ' Episode ' + (i+1)}</p>
                </div>
            </div>
        `;
    }).join('');
}

function toggleWatched(seriesId, seasonNum, epNum, btn) {
    const key = `watched-${seriesId}-s${seasonNum}-e${epNum}`;
    const current = localStorage.getItem(key) === 'true';
    const newState = !current;
    
    localStorage.setItem(key, newState);
    
    const icon = btn.querySelector('i');
    if(newState) {
        btn.classList.remove('text-gray-600', 'hover:text-white');
        btn.classList.add('text-green-500');
        icon.classList.remove('ri-eye-line');
        icon.classList.add('ri-eye-fill');
        showNotification("Marked as Watched", "success");
    } else {
        btn.classList.add('text-gray-600', 'hover:text-white');
        btn.classList.remove('text-green-500');
        icon.classList.add('ri-eye-line');
        icon.classList.remove('ri-eye-fill');
    }
}

function playEpisode(encodedEpData, index, preventHistoryUpdate = false) {
    try {
        const epData = JSON.parse(decodeURIComponent(encodedEpData));
        activeServerList = epData.servers || [];
        activeServerIndex = 0;

        document.querySelectorAll('.ep-card-container').forEach(c => {
            c.classList.remove('active-episode');
            c.style.background = '';
        });
        
        const active = document.getElementById(`ep-card-${index}`);
        if (active) {
            active.classList.add('active-episode');
        }

        if (activeServerList.length > 0) {
            document.getElementById('server-trigger-bar').classList.remove('hidden');
            selectServerFromModal(0);
        } else {
            document.getElementById('server-trigger-bar').classList.add('hidden');
            showNotification("No sources available for this episode.", "error");
        }
        window.scrollTo(0, 0);

        const controlsContainer = document.getElementById('player-controls-container');
        if (controlsContainer) {
            controlsContainer.classList.remove('hidden');
            const hasPrev = index > 0;
            const hasNext = document.getElementById(`ep-card-${index+1}`) !== null;

            controlsContainer.innerHTML = `
                <button onclick="navigateEpisode(${index - 1})" class="flex items-center gap-1 text-xs font-bold ${hasPrev ? 'text-white hover:text-brand' : 'text-gray-600 cursor-not-allowed'}" ${!hasPrev ? 'disabled' : ''}>
                    <i class="ri-skip-back-fill"></i> Prev
                </button>
                <span class="text-xs text-gray-500 font-mono">EP ${index + 1}</span>
                <button onclick="navigateEpisode(${index + 1})" class="flex items-center gap-1 text-xs font-bold ${hasNext ? 'text-white hover:text-brand' : 'text-gray-600 cursor-not-allowed'}" ${!hasNext ? 'disabled' : ''}>
                    Next <i class="ri-skip-forward-fill"></i>
                </button>
            `;
        }

        if (currentSeriesData && !preventHistoryUpdate) {
            let seasonIndex = 1;
            const selectVal = document.getElementById('season-select').value;

            if (selectVal !== 'flat') {
                seasonIndex = parseInt(selectVal) + 1;
            }

            const episodeIndex = index + 1;
            const slug = createSlug(currentSeriesData.title);
            const epUrl = `/series/${currentSeriesData.id}/${slug}/season/${seasonIndex}/episode/${episodeIndex}`;
            updateHistoryState(epUrl);
        }

    } catch (e) {
        console.error("Error playing episode", e);
    }
}

function navigateEpisode(targetIndex) {
    const card = document.getElementById(`ep-card-${targetIndex}`);
    if(card) {
        card.click();
    } else {
        showNotification("No more episodes in this list", "info");
    }
}

function openServerModal() {
    if (!activeServerList || activeServerList.length === 0) return;
    document.getElementById('server-list-container').innerHTML = activeServerList.map((srv, index) => `<div onclick="selectServerFromModal(${index})" class="server-item ${index === activeServerIndex ? 'active' : ''}"><span class="server-name">${srv.name || 'Server '+(index+1)}</span><i class="ri-check-line check-icon"></i></div>`).join('');
    document.getElementById('server-modal').classList.remove('hidden');
}

function closeServerModal() {
    document.getElementById('server-modal').classList.add('hidden');
}

function selectServerFromModal(index) {
    if (!activeServerList[index]) return;
    activeServerIndex = index;
    document.getElementById('current-server-name').innerText = activeServerList[index].name || `Server ${index + 1}`;
    injectVideo(activeServerList[index].url);
    closeServerModal();
}

function injectVideo(link) {
    if (!link) return showNotification("Link unavailable.", "error");
    let f = link;
    if (link.includes('youtube.com') || link.includes('youtu.be')) {
        const vidId = link.includes('v=') ? link.split('v=')[1].split('&')[0] : link.split('youtu.be/')[1];
        f = `https://www.youtube.com/embed/${vidId}?autoplay=1`;
    }
    const wrapper = document.querySelector('.video-wrapper');
    if (wrapper) wrapper.innerHTML = `<iframe src="${f}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
    else document.getElementById('video-area').innerHTML = `<div class="video-wrapper relative"><iframe src="${f}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe></div>`;
}

function closePlayerPage() {
    document.getElementById('video-area').innerHTML = '';
    document.getElementById('player-controls-container').classList.add('hidden');
    updateHistoryState('/');
    showPage('home-page');
}

async function loadDiscoveryTab(isLoadMore = false) {
    const container = document.getElementById('discovery-grid');
    const btn = document.getElementById('discovery-load-more-btn');
    if (!container) return;
    if (!isLoadMore) {
        if (container.dataset.lastVideo !== currentOpenId) {
            container.innerHTML = '';
            container.dataset.lastVideo = currentOpenId;
            pageState.discovery.offset = 0;
        } else if (container.children.length > 0) {
            return;
        }
    }
    if(btn) btn.classList.add('hidden');
    if (!isLoadMore) {
        container.innerHTML = '<div class="col-span-full flex justify-center py-10" id="discovery-loader"><div class="content-loader"></div></div>';
    }
    const rangeFrom = pageState.discovery.offset;
    const rangeTo = rangeFrom + pageState.discovery.limit - 1;
    const { data: movies } = await sb.from('movies').select('*').range(rangeFrom, rangeTo);
    const { data: series } = await sb.from('series').select('*').range(rangeFrom, rangeTo);
    const loader = document.getElementById('discovery-loader');
    if (loader) loader.remove();
    let mix = [
        ...(movies || []).map(i => ({ ...i, type: 'movie' })),
        ...(series || []).map(i => ({ ...i, type: 'series' }))
    ];
    if (mix.length === 0 && !isLoadMore) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No discovery content available.</div>';
        return;
    }
    mix = mix.sort(() => 0.5 - Math.random());
    mix.forEach(i => contentCache.set(String(i.id), i));
    container.insertAdjacentHTML('beforeend', mix.map(item => createPosterCard(item, false)).join(''));
    pageState.discovery.offset += pageState.discovery.limit;
    if (mix.length > 0 && btn) {
        btn.classList.remove('hidden');
    }
}

function loadNextDiscoveryPage() {
    loadDiscoveryTab(true);
}

window.switchTab = function(t) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-white'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    
    const btn = document.getElementById(`tab-${t}`);
    const content = document.getElementById(`content-${t}`);
    
    if(btn) btn.classList.add('active', 'text-white');
    if(content) content.classList.remove('hidden');

    if (t === 'discovery') loadDiscoveryTab(false);
};

function toggleFavorite(id) {
    if (!currentUser) return openAuthModal();
    const sId = String(id);
    const isNowFav = !userFavorites.map(String).includes(sId);
    let newFavs = [...userFavorites];
    if (isNowFav) {
        newFavs.push(sId);
        showNotification("Added to My List", "success");
    } else {
        newFavs = newFavs.filter(fav => String(fav) !== sId);
        showNotification("Removed from My List", "info");
    }
    userFavorites = newFavs;
    document.getElementById('mylist-count').textContent = userFavorites.length;
    const btn = document.getElementById('fav-btn');
    const icon = document.getElementById('fav-icon');
    if (btn && icon) {
        if (isNowFav) {
            btn.classList.add('text-brand');
            icon.className = 'ri-check-line text-lg';
        } else {
            btn.classList.remove('text-brand');
            icon.className = 'ri-add-line text-lg';
        }
    }
    sb.from('profiles').update({
        favorites: newFavs
    }).eq('id', currentUser.id).then(({
        error
    }) => {
        if (error) console.error("Error updating favorites", error);
    });
}

function loadComments(id) {
    sb.from('comments').select('*').eq('content_id', id).order('created_at', {
        ascending: false
    }).limit(20).then(({
        data,
        error
    }) => {
        if (data && data.length > 0) {
            document.getElementById('comments-list').innerHTML = data.map(c => {
                const userName = c.user_email.split('@')[0];
                return `<div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-highlight flex items-center justify-center text-brand font-bold border border-white/10 uppercase">${userName[0]}</div><div><div class="text-xs text-gray-500">${userName} &bull; ${c.created_at ? dayjs(c.created_at).fromNow() : 'Just now'}</div><div class="text-sm text-gray-300">${c.text}</div></div></div>`;
            }).join('');
        } else {
            document.getElementById('comments-list').innerHTML = '<div class="text-center text-gray-600 text-sm">No comments yet.</div>';
        }
    });
}

function postComment() {
    const input = document.getElementById('comment-input');
    const t = input.value.trim();
    if (!currentUser) {
        showNotification("Please login to comment.", "error");
        return openAuthModal();
    }
    if (!t) return;
    if (!currentOpenId) {
        showNotification("Error: Content ID missing. Refresh page.", "error");
        return;
    }
    sb.from('comments').insert({
        content_id: currentOpenId,
        user_email: currentUser.email,
        text: t
    }).then(({ error }) => {
        if (error) {
            console.error("Comment Failed:", error);
            showNotification(`Error: ${error.message}`, "error");
        } else {
            input.value = '';
            loadComments(currentOpenId);
            showNotification("Comment posted!", "success");
        }
    });
}

function openAuthModal() {
    document.getElementById('auth-modal').classList.remove('hidden');
}

function closeAuthModal() {
    document.getElementById('auth-modal').classList.add('hidden');
}
document.getElementById('login-form').addEventListener('submit', e => {
    e.preventDefault();
    sb.auth.signInWithPassword({
        email: document.getElementById('login-email').value,
        password: document.getElementById('login-password').value
    }).then(({
        data,
        error
    }) => {
        if (error) document.getElementById('auth-error').textContent = error.message;
    });
});
document.getElementById('signup-form').addEventListener('submit', e => {
    e.preventDefault();
    sb.auth.signUp({
        email: document.getElementById('signup-email').value,
        password: document.getElementById('signup-password').value
    }).then(({
        data,
        error
    }) => {
        if (error) document.getElementById('auth-error').textContent = error.message;
        else if (data.user) {}
    });
});
document.getElementById('show-signup-btn').addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('login-container').classList.add('hidden');
    document.getElementById('signup-container').classList.remove('hidden');
});
document.getElementById('show-login-btn').addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('signup-container').classList.add('hidden');
    document.getElementById('login-container').classList.remove('hidden');
});

initApp();

--- START OF FILE style.css ---


@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap');

:root {
    --brand-color: #E50914;
    --glass-border: rgba(255, 255, 255, 0.08);
    --glass-highlight: rgba(255, 255, 255, 0.15);
}

body {
    background-color: #000;
    color: #e5e5e5;
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden;
}

.no-scrollbar::-webkit-scrollbar {
    display: none;
}

.page {
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    padding-top: 70px;
}

.page.active {
    display: block;
    opacity: 1;
}

/* --- REPLACED BORDER WITH SHADOW SEPARATOR --- */
.glass-header {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(15px);
    box-shadow: 0 1px 0 0 rgba(255, 255, 255, 0.05); 
    border-bottom: none;
}

.glass-nav {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(20px);
    box-shadow: 0 -1px 0 0 rgba(255, 255, 255, 0.05);
    border-top: none;
}

.video-wrapper {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    background: #000;
    z-index: 50;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,1);
}

.video-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}

.tab-btn.active {
    color: #fff;
    border-bottom: none;
    box-shadow: 0 2px 0 0 var(--brand-color), 0 4px 10px -2px rgba(229, 9, 20, 0.5);
}

/* Draggable Horizontal Lists */
.drag-scroll {
    cursor: grab;
    overflow-x: auto;
    user-select: none;
}

.drag-scroll.active {
    cursor: grabbing;
    cursor: -webkit-grabbing;
    transform: scale(1);
}

/* Rank Numbers */
.rank-number {
    font-size: 8rem;
    line-height: 1;
    font-weight: 900;
    position: absolute;
    left: -10px;
    bottom: -10px;
    color: #000;
    -webkit-text-stroke: 2px #555;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    z-index: 0;
    opacity: 0.8;
    letter-spacing: -10px;
}

.rank-card-image {
    z-index: 10;
    position: relative;
    margin-left: 2rem;
    box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
}

/* --- SERVER MODAL --- */
.server-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: #1A1A1A;
    border: none;
    box-shadow: inset 0 0 0 1px var(--glass-border);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.server-item:hover {
    background: #252525;
    box-shadow: inset 0 0 0 1px var(--glass-highlight);
    transform: translateY(-1px);
}

.server-item.active {
    background: rgba(229, 9, 20, 0.05);
    box-shadow: inset 0 0 0 1px var(--brand-color), 0 0 15px rgba(229, 9, 20, 0.15);
}

.server-item.active .server-name {
    color: var(--brand-color);
    font-weight: 700;
}

.server-item.active .check-icon {
    opacity: 1;
    color: var(--brand-color);
}

.check-icon {
    opacity: 0;
    transition: opacity 0.2s;
}

/* --- CLEAN GENRE CARDS --- */
.genre-card {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
}

.genre-card:hover {
    transform: scale(1.02);
    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
}

/* Removed blur, using gradient overlay */
.genre-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0,0,0,0.2) 60%);
    z-index: 10;
}

.genre-title {
    position: absolute;
    bottom: 15px;
    left: 15px;
    z-index: 20;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
}

/* --- HERO STYLES --- */
#hero-metadata {
    transition: all 0.4s ease-out;
}

.hero-dot {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.hero-slide {
    will-change: opacity;
}

/* --- LOADERS --- */
#app-splash {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background-color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease-out;
}

.splash-loader {
    height: 20px;
    aspect-ratio: 6;
    display: flex;
}

.splash-loader:before,
.splash-loader:after {
    content: "";
    flex: 1;
    padding-left: calc(100%/6);
    background: radial-gradient(closest-side at calc(100%/3) 50%, var(--brand-color) 90%, #0000) 0/75% 100% content-box;
    animation: l20 1.5s infinite;
}

.splash-loader:after {
    --_s: -1;
}

@keyframes l20 {
    0% { transform: scale(var(--_s, 1)) translate(0) rotate(0) }
    25% { transform: scale(var(--_s, 1)) translate(-25%) rotate(0) }
    50% { transform: scale(var(--_s, 1)) translate(-25%) rotate(1turn) }
    75%, 100% { transform: scale(var(--_s, 1)) translate(0) rotate(1turn) }
}

.content-loader-container {
    display: flex;
    justify-content: center;
    padding: 20px;
    width: 100%;
}

.content-loader {
    transform: rotateZ(45deg);
    perspective: 1000px;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    color: #fff;
    position: relative;
}

.content-loader:before,
.content-loader:after {
    content: '';
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    width: inherit;
    height: inherit;
    border-radius: 50%;
    transform: rotateX(70deg);
    animation: 1s spin linear infinite;
}

.content-loader:after {
    color: var(--brand-color);
    transform: rotateY(70deg);
    animation-delay: .4s;
}

@keyframes spin {
    0%, 100% { box-shadow: .2em 0px 0 0px currentcolor; }
    12% { box-shadow: .2em .2em 0 0 currentcolor; }
    25% { box-shadow: 0 .2em 0 0px currentcolor; }
    37% { box-shadow: -.2em .2em 0 0 currentcolor; }
    50% { box-shadow: -.2em 0 0 0 currentcolor; }
    62% { box-shadow: -.2em -.2em 0 0 currentcolor; }
    75% { box-shadow: 0px -.2em 0 0 currentcolor; }
    87% { box-shadow: .2em -.2em 0 0 currentcolor; }
}

/* Load More Button */
.load-more-btn {
    margin: 2rem auto;
    display: block;
    background: #1F1F1F;
    border: none;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1), 0 4px 6px rgba(0,0,0,0.3);
    color: white;
    padding: 12px 30px;
    border-radius: 50px;
    font-weight: bold;
    transition: all 0.2s;
}

.load-more-btn:hover {
    background: var(--brand-color);
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(229, 9, 20, 0.4);
}

.skeleton {
    background: #1F1F1F;
    background-image: linear-gradient(to right, #1F1F1F 0%, #2a2a2a 20%, #1F1F1F 40%, #1F1F1F 100%);
    background-repeat: no-repeat;
    background-size: 800px 100%;
    animation: shimmer 1.5s infinite linear;
}

@keyframes shimmer {
    0% { background-position: -468px 0; }
    100% { background-position: 468px 0; }
}

#global-search-overlay {
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 100;
}

#global-search-overlay.open {
    transform: translateY(0);
}

.toast-enter {
    animation: slideInRight 0.4s forwards;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* --- EPISODE CARD STYLES --- */
.ep-card-container {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: none;
    background-image: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
    background-size: 100% 1px;
    background-position: bottom;
    background-repeat: no-repeat;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
}

.ep-card-container:hover {
    background-color: rgba(255,255,255,0.03);
}

/* ACTIVE EPISODE STYLE */
.ep-card-container.active-episode {
    border: none;
    background: linear-gradient(90deg, rgba(229, 9, 20, 0.15) 0%, rgba(0,0,0,0) 100%) !important;
    border-radius: 8px;
    box-shadow: inset 4px 0 0 0 var(--brand-color);
}

.ep-thumb-wrapper {
    position: relative;
    width: 140px;
    height: 80px;
    flex-shrink: 0;
    border-radius: 6px;
    overflow: hidden;
    background: #222;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
.ep-thumb-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.ep-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.ep-title-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}
.ep-number {
    color: var(--brand-color);
    font-weight: 900;
    font-size: 1.1rem;
}
.ep-title {
    color: white;
    font-weight: 700;
    font-size: 0.95rem;
}
.ep-desc {
    font-size: 0.75rem;
    color: #888;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* --- LOCKED / COMING SOON STYLES --- */
.ep-card-container.locked {
    opacity: 0.6;
    cursor: not-allowed;
}

.ep-card-container.locked .ep-thumb-wrapper::after {
    content: 'COMING SOON';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 1px;
    text-align: center;
    z-index: 10;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(2px);
}

.ep-card-container.locked:hover {
    background: transparent;
}
